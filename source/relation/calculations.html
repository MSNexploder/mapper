<!DOCTYPE html>  <html> <head>   <title>calculations.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="calculations.html">                 calculations.js               </a>                                           <a class="source" href="finder_methods.html">                 finder_methods.js               </a>                                           <a class="source" href="index.html">                 index.js               </a>                                           <a class="source" href="query_methods.html">                 query_methods.js               </a>                                           <a class="source" href="spawn_methods.html">                 spawn_methods.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               calculations.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Module dependencies.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">EventEmitter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">nodes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../nodes&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Relation</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../relation&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Count operates using three different approaches.</p>

<ul>
<li>Count all: By not passing any parameters to count, it will return a count of all the rows for the model.</li>
<li>Count using column: By passing a column name to count, it will return a count of all the
rows for the model with supplied column present.</li>
<li>Count using options will find the row count matched by the options used.</li>
</ul>

<p>The third approach, count using options, accepts an option hash as the only parameter. The options are:</p>

<h4>Parameters</h4>

<ul>
<li><code>conditions</code>: An SQL fragment like "administrator = 1" or [ "user_name = ?", username ].
See conditions in the intro to Base.</li>
<li><code>joins</code>: Either an SQL fragment for additional joins like "LEFT JOIN comments ON comments.post_id = id"
(rarely needed) or named associations in the same form used for the <code>include</code> option, which will
perform an INNER JOIN on the associated table(s). If the value is a string, then the records
will be returned read-only since they will have attributes that do not correspond to the table's columns.
Pass <code>readonly: false</code> to override.</li>
<li><code>include</code>: Named associations that should be loaded alongside using LEFT OUTER JOINs.
The symbols named refer to already defined associations. When using named associations, count
returns the number of DISTINCT items for the model you're counting.
See eager loading under Associations.</li>
<li><code>order</code>: An SQL fragment like "created_at DESC, name" (really only used with GROUP BY calculations).</li>
<li><code>group</code>: An attribute name by which the result should be grouped. Uses the GROUP BY SQL-clause.</li>
<li><code>select</code>: By default, this is * as in SELECT * FROM, but can be changed if you, for example,
want to do a join but not include the joined columns.</li>
<li><code>distinct</code>: Set this to true to make this a distinct calculation, such as
SELECT COUNT(DISTINCT posts.id) ...</li>
<li><code>from</code> - By default, this is the table name of the class, but can be changed to an
alternate table name (or even the name of a database view).</li>
</ul>

<h4>Emits</h4>

<p>Triggers an <code>value</code> event once the object count is evaluated.</p>

<h4>Examples</h4>

<p>Examples for counting all:
    Person.count();      // returns the total count of all people</p>

<p>Examples for counting by column:
    Person.count('age'); // returns the total count of all people whose age is present in database</p>

<p>Examples for count with options:
    Person.count({conditions: "age > 26"});</p>

<pre><code>// because of the named association, it finds the DISTINCT count using LEFT OUTER JOIN.
Person.count({conditions: "age &gt; 26 AND job.salary &gt; 60000", include: 'job'});

// finds the number of rows matching the conditions and joins.
Person.count({conditions: "age &gt; 26 AND job.salary &gt; 60000",
             joins: "LEFT JOIN jobs on jobs.person_id = person.id"});

Person.count('id', {:conditions =&gt; "age &gt; 26"});  // Performs a COUNT(id)
Person.count('all', {:conditions =&gt; "age &gt; 26"}); // Performs a COUNT(*) ('all' is an alias for '*')
</code></pre>

<p>Note: <code>Person.count('all');</code> will not work because it will use <code>all</code> as the condition.
Use Person.count instead.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Relation</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column_name</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">===</span> <span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">column_name</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> <span class="o">||</span> <span class="nx">column_name</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">options</span> <span class="o">=</span> <span class="nx">column_name</span><span class="p">;</span>
        <span class="nx">column_name</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">calculate</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="nx">column_name</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Calculates the average value on a given column. Emits <code>undefined</code> if there's
no row. See <code>calculate</code> for examples with options.</p>

<pre><code>Person.average('age'); // =&gt; 35.8
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Relation</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">average</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column_name</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">calculate</span><span class="p">(</span><span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="nx">column_name</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Calculates the minimum value on a given column. Emits <code>undefined</code> if there's
no row. See <code>calculate</code> for examples with options.</p>

<pre><code>Person.minimum('age'); // =&gt; 7
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Relation</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">minimum</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column_name</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">calculate</span><span class="p">(</span><span class="s1">&#39;minimum&#39;</span><span class="p">,</span> <span class="nx">column_name</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Calculates the maximum value on a given column. Emits <code>undefined</code> if there's
no row. See <code>calculate</code> for examples with options.</p>

<pre><code>Person.maximum('age'); // =&gt; 93
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Relation</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">maximum</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column_name</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">calculate</span><span class="p">(</span><span class="s1">&#39;maximum&#39;</span><span class="p">,</span> <span class="nx">column_name</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Calculates the sum of values on a given column. Emits <code>undefined</code> if there's
no row. See <code>calculate</code> for examples with options.</p>

<pre><code>Person.sum('age'); // =&gt; 4562
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Relation</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sum</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column_name</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">calculate</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="nx">column_name</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>This calculates aggregate values in the given column. Methods for count, sum, average,
minimum, and maximum have been added as shortcuts. Options such as <code>conditions</code>,
<code>order</code>, <code>group</code>, <code>having</code>, and <code>joins</code> can be passed to customize the query.</p>

<h4>Parameters</h4>

<ul>
<li><code>conditions</code> - An SQL fragment like "administrator = 1" or [ "user_name = ?", username ].
See conditions in the intro to Base.</li>
<li><code>include</code>: Eager loading, see Associations for details.  Since calculations don't load anything,
the purpose of this is to access fields on joined tables in your conditions, order, or group clauses.</li>
<li><code>joins</code> - An SQL fragment for additional joins like "LEFT JOIN comments ON comments.post_id = id".
(Rarely needed).
The records will be returned read-only since they will have attributes that do not correspond to the
table's columns.</li>
<li><code>order</code> - An SQL fragment like "created_at DESC, name" (really only used with GROUP BY calculations).</li>
<li><code>group</code> - An attribute name by which the result should be grouped. Uses the GROUP BY SQL-clause.</li>
<li><code>select</code> - By default, this is * as in SELECT * FROM, but can be changed if you for example
want to do a join, but not include the joined columns.</li>
<li><code>distinct</code> - Set this to true to make this a distinct calculation, such as
SELECT COUNT(DISTINCT posts.id) ...</li>
</ul>

<h4>Emits</h4>

<p>Triggers an <code>value</code> event once the object count is evaluated.</p>

<h4>Examples</h4>

<pre><code>Person.calculate('count, 'all'); // The same as Person.count();
Person.average('age'); // SELECT AVG(age) FROM people...
Person.minimum('age', {conditions: ['last_name != ?', 'Drake']}); // Selects the minimum age for
                                                                  // everyone with a last name other than 'Drake'

// Selects the minimum age for any family without any minors
Person.minimum('age', {having: 'min(age) &gt; 17', group: 'last_name'});

Person.sum("2 * age");
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Relation</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">calculate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">operation</span><span class="p">,</span> <span class="nx">column_name</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">options_without_distinct</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="s1">&#39;distinct&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">options_without_distinct</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">options_without_distinct</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">applyFinderOptions</span><span class="p">(</span><span class="nx">options_without_distinct</span><span class="p">).</span><span class="nx">calculate</span><span class="p">(</span><span class="nx">operation</span><span class="p">,</span> <span class="nx">column_name</span><span class="p">,</span> <span class="p">{</span><span class="nx">distinct</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">distinct</span><span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">includes_values</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">includes_values</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructRelationForAssociationCalculations</span><span class="p">().</span><span class="nx">calculate</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">column_name</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">performCalculation</span><span class="p">(</span><span class="nx">operation</span><span class="p">,</span> <span class="nx">column_name</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>private methods</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Relation</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">performCalculation</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">operation</span><span class="p">,</span> <span class="nx">column_name</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">operation</span> <span class="o">=</span> <span class="nx">operation</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">operation</span> <span class="o">==</span> <span class="s1">&#39;count&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">column_name</span> <span class="o">=</span> <span class="nx">column_name</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectForCount</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">group_values</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">executeGroupedCalculation</span><span class="p">(</span><span class="nx">operation</span><span class="p">,</span> <span class="nx">column_name</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">distinct</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">executeSimpleCalculation</span><span class="p">(</span><span class="nx">operation</span><span class="p">,</span> <span class="nx">column_name</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">distinct</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">Relation</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">executeSimpleCalculation</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">operation</span><span class="p">,</span> <span class="nx">column_name</span><span class="p">,</span> <span class="nx">distinct</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">column</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">aggregateColumn</span><span class="p">(</span><span class="nx">column_name</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">relation</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">except</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">select_value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">operationOverAggregateColumn</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">operation</span><span class="p">,</span> <span class="nx">distinct</span><span class="p">);</span>

    <span class="nx">relation</span><span class="p">.</span><span class="nx">select_values</span> <span class="o">=</span> <span class="p">[</span><span class="nx">select_value</span><span class="p">];</span>

    <span class="kd">var</span> <span class="nx">event_emitter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventEmitter</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">klass</span><span class="p">.</span><span class="nx">tableConnection</span><span class="p">().</span><span class="nx">selectValue</span><span class="p">(</span><span class="nx">relation</span><span class="p">.</span><span class="nx">toSql</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">event_emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">===</span> <span class="nx">value</span> <span class="o">||</span> <span class="kc">undefined</span> <span class="o">===</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span> <span class="nx">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

        <span class="nx">event_emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">event_emitter</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">Relation</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">executeGroupedCalculation</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">operation</span><span class="p">,</span> <span class="nx">column_name</span><span class="p">,</span> <span class="nx">distinct</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">group_attr</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">group_values</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">association</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">klass</span><span class="p">.</span><span class="nx">reflectOnAssociation</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">first</span><span class="p">(</span><span class="nx">group_attr</span><span class="p">));</span>
    <span class="kd">var</span> <span class="nx">associated</span> <span class="o">=</span> <span class="nx">group_attr</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">association</span> <span class="o">&amp;&amp;</span> <span class="nx">association</span><span class="p">.</span><span class="nx">macro</span> <span class="o">==</span> <span class="s1">&#39;belongs_to&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">group_fields</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">flatten</span><span class="p">([</span><span class="nx">associated</span> <span class="o">?</span> <span class="nx">association</span><span class="p">.</span><span class="nx">foreign_key</span> <span class="o">:</span> <span class="nx">group_attr</span><span class="p">]);</span>

    <span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="nx">group_fields</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">aggregate_alias</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">operation</span> <span class="o">==</span> <span class="s1">&#39;count&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">column_name</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">aggregate_alias</span> <span class="o">=</span> <span class="s1">&#39;count_all&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">aggregate_alias</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">columnAliasFor</span><span class="p">(</span><span class="nx">operation</span><span class="p">,</span> <span class="nx">column_name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">select_values</span> <span class="o">=</span> <span class="p">[</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">operationOverAggregateColumn</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">aggregateColumn</span><span class="p">(</span><span class="nx">column_name</span><span class="p">),</span> <span class="nx">operation</span><span class="p">,</span> <span class="nx">distinct</span><span class="p">).</span><span class="nx">as</span><span class="p">(</span><span class="nx">aggregate_alias</span><span class="p">)</span>
    <span class="p">];</span>

    <span class="nx">select_values</span> <span class="o">=</span> <span class="nx">select_values</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">group_fields</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">field</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">nodes</span><span class="p">.</span><span class="nx">sql</span><span class="p">(</span><span class="nx">field</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; AS &#39;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">columnAliasFor</span><span class="p">(</span><span class="nx">field</span><span class="p">).</span><span class="nx">toString</span><span class="p">());</span>
    <span class="p">}));</span>

    <span class="kd">var</span> <span class="nx">relation</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">except</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">).</span><span class="nx">group</span><span class="p">(</span><span class="nx">group</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">));</span>
    <span class="nx">relation</span><span class="p">.</span><span class="nx">select_values</span> <span class="o">=</span> <span class="nx">select_values</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">event_emitter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventEmitter</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">klass</span><span class="p">.</span><span class="nx">tableConnection</span><span class="p">().</span><span class="nx">selectAll</span><span class="p">(</span><span class="nx">relation</span><span class="p">.</span><span class="nx">toSql</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">event_emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">===</span> <span class="nx">value</span> <span class="o">||</span> <span class="kc">undefined</span> <span class="o">===</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span> <span class="nx">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

        <span class="nx">event_emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">event_emitter</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">Relation</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">aggregateColumn</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column_name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">===</span> <span class="nx">column_name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">nodes</span><span class="p">.</span><span class="nx">sql</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">.</span><span class="nx">column</span><span class="p">(</span><span class="nx">column_name</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">Relation</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">operationOverAggregateColumn</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span> <span class="nx">operation</span><span class="p">,</span> <span class="nx">distinct</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">operation</span> <span class="o">==</span> <span class="s1">&#39;count&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">column</span><span class="p">.</span><span class="nx">count</span><span class="p">(</span><span class="nx">distinct</span><span class="p">)</span> <span class="o">:</span> <span class="nx">column</span><span class="p">[</span><span class="nx">operation</span><span class="p">]();</span>
<span class="p">};</span>

<span class="nx">Relation</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">selectForCount</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">select_values</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">first</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">select_values</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Converts the given keys to the value that the database adapter returns as
a usable column name:</p>

<p>columnAliasFor("users.id");                 // => "users<em>id"
  columnAliasFor("sum(id)");                  // => "sum</em>id"
  columnAliasFor("count(distinct users.id)"); // => "count<em>distinct</em>users<em>id"
  columnAliasFor("count(*)");                 // => "count</em>all"
  columnAliasFor("count", "id");              // => "count_id"</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Relation</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">columnAliasFor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">keys</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">keys</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">keys</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\*/g</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">);</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\W+/g</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">);</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s*/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s*$/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/ +/g</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">Relation</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">columnFor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">field</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">field_name</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">last</span><span class="p">(</span><span class="nx">field</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">));</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">detect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">klass</span><span class="p">.</span><span class="nx">columns</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">column</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">column</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">==</span> <span class="nx">field_name</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">};</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 